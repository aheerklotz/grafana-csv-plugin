{"version":3,"sources":["../src/response_parser.js"],"names":["_","ResponseParse","res","data","results","key","queryRes","series","push","target","name","datapoints","points","refId","meta","tables","table","type","columns","rows","textColIndex","findColIndex","valueColIndex","length","transformToKeyValueList","transformToSimpleList","i","containsKey","text","value","j","indexOf","map","colName","options","annotation","timeColumnIndex","timeEndColumnIndex","textColumnIndex","tagsColumnIndex","Promise","reject","message","list","row","timeEnd","Math","floor","undefined","time","toString","tags","trim","split"],"mappings":"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","file":"response_parser.js","sourcesContent":["import _ from 'lodash';\n\nexport default class ResponseParse {\n\n  processQueryResult(res) {\n    const data = [];\n\n    if (!res.data.results) {\n      return { data: data };\n    }\n\n    for (const key in res.data.results) {\n      const queryRes = res.data.results[key];\n\n      if (queryRes.series) {\n        for (const series of queryRes.series) {\n          data.push({\n            target: series.name,\n            datapoints: series.points,\n            refId: queryRes.refId,\n            meta: queryRes.meta,\n          });\n        }\n      }\n\n      if (queryRes.tables) {\n        for (const table of queryRes.tables) {\n          table.type = 'table';\n          table.refId = queryRes.refId;\n          table.meta = queryRes.meta;\n          data.push(table);\n        }\n      }\n    }\n\n    return { data: data };\n  }\n\n  parseMetricFindQueryResult(refId, results) {\n    if (!results) {\n      return [];\n    }\n\n    const columns = results.data.results[refId].tables[0].columns;\n    const rows = results.data.results[refId].tables[0].rows;\n    const textColIndex = this.findColIndex(columns, '__text');\n    const valueColIndex = this.findColIndex(columns, '__value');\n\n    if (columns.length === 2 && textColIndex !== -1 && valueColIndex !== -1) {\n      return this.transformToKeyValueList(rows, textColIndex, valueColIndex);\n    }\n\n    return this.transformToSimpleList(rows);\n  }\n\n  transformToKeyValueList(rows, textColIndex, valueColIndex) {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      if (!this.containsKey(res, rows[i][textColIndex])) {\n        res.push({\n          text: rows[i][textColIndex],\n          value: rows[i][valueColIndex],\n        });\n      }\n    }\n\n    return res;\n  }\n\n  transformToSimpleList(rows) {\n    const res = [];\n\n    for (let i = 0; i < rows.length; i++) {\n      for (let j = 0; j < rows[i].length; j++) {\n        const value = rows[i][j];\n        if (res.indexOf(value) === -1) {\n          res.push(value);\n        }\n      }\n    }\n\n    return _.map(res, value => {\n      return { text: value };\n    });\n  }\n\n  findColIndex(columns, colName) {\n    for (let i = 0; i < columns.length; i++) {\n      if (columns[i].text === colName) {\n        return i;\n      }\n    }\n\n    return -1;\n  }\n\n  containsKey(res, key) {\n    for (let i = 0; i < res.length; i++) {\n      if (res[i].text === key) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  transformAnnotationResponse(options, data) {\n    const table = data.data.results[options.annotation.name].tables[0];\n\n    let timeColumnIndex = -1;\n    let timeEndColumnIndex = -1;\n    let textColumnIndex = -1;\n    let tagsColumnIndex = -1;\n\n    for (let i = 0; i < table.columns.length; i++) {\n      if (table.columns[i].text === 'time_sec' || table.columns[i].text === 'time') {\n        timeColumnIndex = i;\n      } else if (table.columns[i].text === 'timeend') {\n        timeEndColumnIndex = i;\n      } else if (table.columns[i].text === 'title') {\n        return Promise.reject({\n          message: 'The title column for annotations is deprecated, now only a column named text is returned',\n        });\n      } else if (table.columns[i].text === 'text') {\n        textColumnIndex = i;\n      } else if (table.columns[i].text === 'tags') {\n        tagsColumnIndex = i;\n      }\n    }\n\n    if (timeColumnIndex === -1) {\n      return Promise.reject({\n        message: 'Missing mandatory time column (with time_sec column alias) in annotation query.',\n      });\n    }\n\n    const list = [];\n    for (let i = 0; i < table.rows.length; i++) {\n      const row = table.rows[i];\n      const timeEnd =\n        timeEndColumnIndex !== -1 && row[timeEndColumnIndex] ? Math.floor(row[timeEndColumnIndex]) : undefined;\n      list.push({\n        annotation: options.annotation,\n        time: Math.floor(row[timeColumnIndex]),\n        timeEnd,\n        text: row[textColumnIndex] ? row[textColumnIndex].toString() : '',\n        tags: row[tagsColumnIndex] ? row[tagsColumnIndex].trim().split(/\\s*,\\s*/) : [],\n      });\n    }\n\n    return list;\n  }\n}\n"]}